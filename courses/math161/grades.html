
<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="description" content="Personal website of Ben Fraser, with math education activities for students and teachers.">
  <meta charset="UTF-8" />
  <title>Grade Calculation Activity</title>
  <link rel="stylesheet" href="/style.css" />

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
</head>
<body>
  <header>
    <h1>Grade Calculation Activity</h1>
    <div id="nav-placeholder"></div>
      <script>
fetch("/nav.html")
  .then(response => response.text())
  .then(html => {
    document.getElementById("nav-placeholder").innerHTML = html;

    const currentPath = window.location.pathname.replace(/\/index\.html$/, "/");
    const navLinks = document.querySelectorAll("#nav-placeholder a");
    navLinks.forEach(link => {
      const linkPath = new URL(link.href).pathname.replace(/\/index\.html$/, "/");
      if (linkPath === currentPath) {
        link.classList.add("active");
      }
    });

    const s = document.createElement("script");
    s.src = "/mascot.js";
    s.defer = true;
    document.body.appendChild(s); 
  })
  .catch(err => {
    console.error("Failed to load nav:", err);
  });
</script>
  </header>
  <main>

    <p>One of the most familiar experiences a student has with weighted averages is in calculating their grade in a course.  If until this point you've 
    used an online calculator to do this for you, it's time to take off the training wheels and do it by hand!</p>

    <p><u><b>Unweighted Averages:</b></u></p>

    <p>Finding the average of a set of numbers which are all given equal weight is simple: just add them up, and divide by the number of numbers.  Why?
      If your grade in a course is determined solely by 5 tests of equal weight, then each grade has weight one fifth.  If the grades you got are
    \[40, 50, 70, 75, 90\]
    then your grade in the course is
    \[40\left(\frac{1}{5}\right) + 50\left(\frac{1}{5}\right) + 70\left(\frac{1}{5}\right) + 75\left(\frac{1}{5}\right) + 90\left(\frac{1}{5}\right) = 65\]</p>

    <p><u><b>Weighted Averages:</b></u></p>

    <p>More often, different components of a course are weighted differently.  Now, suppose you scored 70 on Test 1 (worth 20%), 40 on Test 2 (worth 
    20%), 80 on your Final Presentation (worth 10%), and 75 on the Final Exam (worth 50%).  We can find the weighted average as follows:
    \[70\left(\frac{20}{100}\right) + 40\left(\frac{20}{100}\right) + 80\left(\frac{10}{100}\right) + 75\left(\frac{50}{100}\right) = 67.5\]</p>

    <p><u><b>What grade do I need on the final exam?</b></u></p>

    <p>Depends what final grade in the course you're aiming for, how heavily the final exam is weighted, and what your grade so far is!  Suppose you 
    scored 65 on your Midterm (worth 30%), 20 on Participation (worth 10%), and 30 on your Term Paper (worth 20%).  What grade do you need on the final 
    exam (worth 40%) to have a final grade of 60%?</p>

    <p>We can start by computing our current grade in the course, as a weighted average (note that the fractions are out of 60 because so far 60% of the 
      course grade is in - we are missing the 40% final exam):
    \[65\left(\frac{30}{60}\right) + 20\left(\frac{10}{60}\right) + 30\left(\frac{20}{60}\right) = \frac{275}{6} = 45.8\overline{3}\]
    We want a final grade of 60.  So we are trying to solve for the final exam grade x in the following equation:
    \[\frac{275}{6}\left(\frac{60}{100}\right) + x\left(\frac{40}{100}\right) = 60 \implies x\left(\frac{40}{100}\right) = 60 - \frac{275}{6}\left(\frac{60}{100}\right)
      \implies x = \frac{60 - \frac{275}{6}\left(\frac{60}{100}\right)}{\frac{40}{100}} = 81.25\]</p>

    <div class="button-container">
      <button id="start-btn" class="rubber-button">Start!</button>
    </div>
    
    <div id="activity-area" class="math" style="margin-top: 1em;"></div>

    <div class="button-container">
      <button id="hint-btn" class="rubber-button">Hint</button>
    </div>

    <div id="hint-area" class="math" style="margin-top: 1em;"></div>

    <div id="answer-section" style="margin-top: 20px; text-align: center;">
      <label id="answer-label" for="user-answer">Enter your current grade in the course:</label>
      <input type="text" id="user-answer" />
      <button id="check-answer-btn" class="rubber-button" style="margin-left: 0.5em;">Check Answer</button>
      <p id="answer-feedback" style="font-weight: bold; margin-top: 10px;"></p>
    </div>

  </main>
  <script>
    // -----------------------------
    // State
    // -----------------------------
    let scenario = null; // generated when Start is pressed
    let stage = 0;       // 0 = not started, 1 = ask current grade, 2 = ask required final exam grade

    const startBtn = document.getElementById('start-btn');
    const hintBtn = document.getElementById('hint-btn');

    const activityArea = document.getElementById('activity-area');
    const hintArea = document.getElementById('hint-area');

    const answerLabel = document.getElementById('answer-label');
    const answerInput = document.getElementById('user-answer');
    const checkBtn = document.getElementById('check-answer-btn');
    const feedback = document.getElementById('answer-feedback');

    // -----------------------------
    // Helpers
    // -----------------------------
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function playClick() {
      const sound = document.getElementById('click-sound');
      if (sound) {
        sound.currentTime = 0;
        sound.play();
      }
    }

    // Random positive integer weights that sum to total
    function randomComposition(k, total) {
      // Choose k-1 cut points from 1..total-1
      const cuts = [];
      for (let i = 0; i < k - 1; i++) {
        cuts.push(randInt(1, total - 1));
      }
      cuts.sort((a, b) => a - b);

      const parts = [];
      let prev = 0;
      for (const c of cuts) {
        parts.push(c - prev);
        prev = c;
      }
      parts.push(total - prev);
      return parts;
    }

    function toOneDecimal(x) {
      return Math.round(x * 10) / 10;
    }

    function parseNumber(str) {
      const s = (str || '').trim();
      if (!s) return null;

      // Accept fractions like "3/4" (with optional spaces, optional leading sign)
      const fracMatch = s.match(/^([+-]?\d+)\s*\/\s*([+-]?\d+)$/);
      if (fracMatch) {
        const num = Number(fracMatch[1]);
        const den = Number(fracMatch[2]);
        if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return null;
        return num / den;
      }

      // Otherwise treat as decimal / integer
      const n = Number(s);
      if (!Number.isFinite(n)) return null;
      return n;
    }

    function roughlyEqual(a, b, tol = 0.1) {
      return Math.abs(a - b) <= tol;
    }

    function renderScenario() {
      if (!scenario) return;

      // Build a simple table (HTML)
      let html = '';
      html += '<div style="max-width: 900px; margin: 0 auto; text-align: left;">';
      html += '<p><b>Your course components:</b></p>';
      html += '<table style="border-collapse: collapse; width: 100%;">';
      html += '<tr><th style="border-bottom: 1px solid #999; padding: 6px 8px; text-align: left;">Component</th>';
      html += '<th style="border-bottom: 1px solid #999; padding: 6px 8px; text-align: right;">Weight</th>';
      html += '<th style="border-bottom: 1px solid #999; padding: 6px 8px; text-align: right;">Grade</th></tr>';

      scenario.components.forEach(c => {
        const gradeText = (c.type === 'final') ? '<i>unknown</i>' : `${c.grade}%`;
        html += '<tr>';
        html += `<td style="padding: 6px 8px;">${c.name}</td>`;
        html += `<td style="padding: 6px 8px; text-align: right;">${c.weight}%</td>`;
        html += `<td style="padding: 6px 8px; text-align: right;">${gradeText}</td>`;
        html += '</tr>';
      });

      html += '</table>';
      html += `<p style="margin-top: 12px;"><b>Target final course grade:</b> ${scenario.targetFinalCourseGrade}%</p>`;
      html += '</div>';

      activityArea.innerHTML = html;
    }

    function renderHint() {
      if (!scenario) {
        hintArea.innerHTML = '<p>No hints yet. Press Start first.</p>';
        return;
      }

      const fW = scenario.finalExamWeight;
      const nf = scenario.nonFinalTotalWeight;

      // Current grade so far:
      const sumStr = scenario.nonFinalComponents
        .map(c => `${c.grade}\\left(\\frac{${c.weight}}{${nf}}\\right)`)
        .join(' + ');

      const currentExact = scenario.currentGradeSoFarExact;
      const current1 = toOneDecimal(currentExact);

      const reqExact = scenario.requiredFinalExamExact;

      const hintTeX = `
        <div class="hint-step">
          \\[\\textbf{Step 1: Compute your current grade (so far).}\\]
          \\[\\text{So far, } ${nf}\\% \\text{ of the course is in, so divide weights by } ${nf}.\\]
          \\[\\text{Current grade} = ${sumStr} = ${current1}\\]
        </div>
        <div class="hint-step" style="margin-top: 1em;">
          \\[\\textbf{Step 2: Solve for the final exam grade } x.\\]
          \\[\\text{Final course grade} = (\\text{current grade})\\left(\\frac{${nf}}{100}\\right) + x\\left(\\frac{${fW}}{100}\\right)\\]
          \\[${current1}\\left(\\frac{${nf}}{100}\\right) + x\\left(\\frac{${fW}}{100}\\right) = ${scenario.targetFinalCourseGrade}\\]
          \\[x = \\frac{${scenario.targetFinalCourseGrade} - ${current1}\\left(\\frac{${nf}}{100}\\right)}{\\left(\\frac{${fW}}{100}\\right)} \\approx ${toOneDecimal(reqExact)}\\]
        </div>
      `;

      hintArea.innerHTML = hintTeX;
      if (window.MathJax && MathJax.typeset) {
        MathJax.typeset([hintArea]);
      }
    }

    function resetUIForNewScenario() {
      hintArea.innerHTML = '';
      feedback.textContent = '';
      feedback.style.color = 'black';
      answerInput.value = '';

      const note = document.getElementById('over-100-note');
      if (note) note.remove();

      answerLabel.textContent = 'Enter your current grade in the course:';
      checkBtn.textContent = 'Check Answer';
      stage = 1;

      if (window.MathJax && MathJax.typeset) {
        MathJax.typeset([activityArea]);
      }
    }

    // -----------------------------
    // Scenario generation
    // -----------------------------
    function generateScenario() {
      // We generate weights/grades first, then choose a target in [50,70]
      // that is achievable with a final exam score of 100 or less.
      // If the required score would be negative, then 0 will be treated as correct.

      while (true) {
        const finalExamWeight = randInt(10, 50);
        const numOther = randInt(3, 6);

        const nonFinalTotalWeight = 100 - finalExamWeight;
        const otherWeights = randomComposition(numOther, nonFinalTotalWeight);

        const nonFinalComponents = otherWeights.map((w, i) => ({
          name: `Component ${i + 1}`,
          weight: w,
          grade: randInt(0, 100),
          type: 'nonfinal'
        }));

        const finalComponent = { name: 'Final Exam', weight: finalExamWeight, grade: null, type: 'final' };

        // Current grade so far (weighted over the non-final total)
        const sumWeighted = nonFinalComponents.reduce((acc, c) => acc + c.grade * c.weight, 0);
        const currentGradeSoFarExact = sumWeighted / nonFinalTotalWeight;

        // With final exam score x in [0,100], achievable final-course grade range is:
        const minAchievable = currentGradeSoFarExact * (nonFinalTotalWeight / 100); // x = 0
        const maxAchievable = minAchievable + 100 * (finalExamWeight / 100);       // x = 100

        // Pick a target integer in [50,70] that is <= maxAchievable (so x <= 100 is possible).
        const upper = Math.min(70, Math.floor(maxAchievable));
        if (upper < 50) continue; // impossible to hit even 50 with x <= 100, regenerate

        const targetFinalCourseGrade = randInt(50, upper);

        // Required final exam grade x for target:
        const requiredFinalExamExact =
          (targetFinalCourseGrade - currentGradeSoFarExact * (nonFinalTotalWeight / 100)) / (finalExamWeight / 100);

        const components = [...nonFinalComponents, finalComponent];

        return {
          finalExamWeight,
          numOther,
          nonFinalTotalWeight,
          components,
          nonFinalComponents,
          currentGradeSoFarExact,
          targetFinalCourseGrade,
          requiredFinalExamExact
        };
      }
    }

    // -----------------------------
    // Start button
    // -----------------------------
    startBtn.addEventListener('click', () => {
      playClick();

      scenario = generateScenario();
      renderScenario();
      resetUIForNewScenario();
    });

    // -----------------------------
    // Hint button
    // -----------------------------
    hintBtn.addEventListener('click', () => {
      playClick();
      renderHint();
    });

    // -----------------------------
    // Check answer
    // -----------------------------
    checkBtn.addEventListener('click', () => {
      playClick();

      if (!scenario || stage === 0) {
        feedback.textContent = 'Press Start to generate a problem first.';
        feedback.style.color = 'black';
        return;
      }

      const userVal = parseNumber(answerInput.value);
      if (userVal === null) {
        feedback.textContent = 'Please enter a number.';
        feedback.style.color = 'black';
        return;
      }

      if (stage === 1) {
        const correct = scenario.currentGradeSoFarExact;
        const ok = roughlyEqual(userVal, correct, 0.1);

        if (ok) {
          feedback.textContent = 'Correct! Now solve for the minimum final exam grade needed.';
          feedback.style.color = 'green';

          stage = 2;
          answerInput.value = '';
          answerLabel.textContent = 'Enter the minimum final exam grade needed to hit the target final course grade:';
        } else {
          feedback.textContent = 'Not quite. Try again (fractions OK; within 0.1 is accepted).';
          feedback.style.color = 'red';
        }
        return;
      }

      if (stage === 2) {
        // If the algebra gives a negative required score, then 0 on the final is already enough,
        // so we treat 0 as the correct minimum.
        const raw = scenario.requiredFinalExamExact;
        const correct = Math.max(0, raw);
        const ok = roughlyEqual(userVal, correct, 0.1);

        if (ok) {
          feedback.textContent = 'Correct! Press Start for a new random scenario.';
          feedback.style.color = 'green';
        } else {
          feedback.textContent = 'Incorrect. Try again (fractions OK; within 0.1 is accepted).';
          feedback.style.color = 'red';
        }
      }
    });

  </script>
  <audio id="click-sound" src="button.mp3" preload="auto"></audio>
  <audio id="set-sound" src="set2.mp3" preload="auto"></audio>

</body>
</html>
